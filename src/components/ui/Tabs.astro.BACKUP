---
<!
  Tabs.astro — Mutually exclusive tab panels.
 
  Props:
    id     – Required. Base ID for ARIA relationships and deep linking.
    accent – 'teal' | 'amber' | 'blue' | 'gradient' (default: 'teal')
    labels – string[] of tab labels (e.g. ['Overview', 'Frameworks', 'Questions'])
 
  Slots:
    tab-0, tab-1, tab-2, ... — Content for each tab panel
 
  Deep linking:
    #id--label (slugified) activates that tab on load.
    e.g. #d5-tabs--frameworks
 >

interface Props {
  id: string;
  accent?: 'teal' | 'amber' | 'blue' | 'gradient';
  labels: string[];
}

const {
  id,
  accent = 'teal',
  labels = [],
} = Astro.props;

const maxSupported = 8;
const actualCount = Math.min(labels.length, maxSupported);

function slugify(str: string): string {
  return str.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
}
---

<div class={`tabs tabs--${accent}`} id={id} data-tabs>
  <div class="tabs__strip" role="tablist" aria-label={`${id} tabs`}>
    {labels.map((label, i) => (
      <button
        class="tabs__tab"
        role="tab"
        aria-selected={i === 0 ? 'true' : 'false'}
        aria-controls={`${id}-panel-${i}`}
        id={`${id}-btn-${i}`}
        data-tab-slug={slugify(label)}
        tabindex={i === 0 ? undefined : '-1'}
      >
        {label}
      </button>
    ))}
  </div>
  {labels.map((label, i) => (
    <div
      class="tabs__panel"
      role="tabpanel"
      id={`${id}-panel-${i}`}
      aria-labelledby={`${id}-btn-${i}`}
      aria-label={label}
      hidden={i !== 0 ? true : undefined}
    >
      <slot name={`tab-${i}`} />
    </div>
  ))}
</div>

<script>
  function initTabs() {
    document.querySelectorAll('[data-tabs]').forEach((tabGroup) => {
      if (tabGroup.hasAttribute('data-tabs-bound')) return;

      const tabs = tabGroup.querySelectorAll('[role="tab"]');
      const panels = tabGroup.querySelectorAll('[role="tabpanel"]');

      function activateTab(tab) {
        tabs.forEach((t) => {
          t.setAttribute('aria-selected', 'false');
          t.setAttribute('tabindex', '-1');
        });
        panels.forEach((p) => (p.hidden = true));

        tab.setAttribute('aria-selected', 'true');
        tab.removeAttribute('tabindex');
        const panel = document.getElementById(tab.getAttribute('aria-controls'));
        if (panel) panel.hidden = false;
      }

      tabs.forEach((tab) => {
        tab.addEventListener('click', () => activateTab(tab));

        tab.addEventListener('keydown', (e) => {
          const tabsArray = Array.from(tabs);
          const index = tabsArray.indexOf(tab);
          let newIndex;

          if (e.key === 'ArrowRight') newIndex = (index + 1) % tabsArray.length;
          else if (e.key === 'ArrowLeft') newIndex = (index - 1 + tabsArray.length) % tabsArray.length;
          else return;

          e.preventDefault();
          activateTab(tabsArray[newIndex]);
          tabsArray[newIndex].focus();
        });
      });

      tabGroup.setAttribute('data-tabs-bound', 'true');
    });

    // Deep link handling for tabs
    handleTabHash();
  }

  function handleTabHash() {
    const hash = window.location.hash.replace('#', '');
    if (!hash || !hash.includes('--')) return;

    const [groupId, tabSlug] = hash.split('--');
    const tabGroup = document.getElementById(groupId);
    if (!tabGroup) return;

    const targetTab = tabGroup.querySelector(`[data-tab-slug="${tabSlug}"]`);
    if (targetTab) {
      targetTab.click();
      requestAnimationFrame(() => {
        tabGroup.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    }
  }

  document.addEventListener('astro:page-load', initTabs);
  document.addEventListener('astro:after-swap', initTabs);
  window.addEventListener('hashchange', handleTabHash);
  initTabs();
</script>
