---
interface ExpandingCardItem {
  id: string;
  label: string;
  title: string;
  description: string;
  accentToken?: string;
}

interface ExpandingCardSlot {
  id: string;
  label: string;
  depth?: number;
  position?: number;
  accentToken?: string;
}

interface Props {
  items?: ExpandingCardItem[];
  cards?: ExpandingCardSlot[];
  orientation?: 'horizontal' | 'vertical';
  defaultActive?: string;
}

const {
  items = [],
  cards = [],
  orientation = 'vertical',
  defaultActive,
} = Astro.props;

const isSlotted = cards.length > 0;
const allCards = isSlotted ? cards : items;

const initialActive = defaultActive && allCards.some((c) => c.id === defaultActive)
  ? defaultActive
  : allCards[0]?.id;

const containerClass = [
  'expanding-cards',
  `expanding-cards--${orientation}`,
  isSlotted ? 'expanding-cards--slotted' : '',
].filter(Boolean).join(' ');
---

<div
  class={containerClass}
  data-expanding-cards
  data-orientation={orientation}
  data-default-active={initialActive}
>
  {isSlotted ? (
    cards.map(async (card) => {
      const hasSlot = Astro.slots.has(card.id);
      const slotHtml = hasSlot ? await Astro.slots.render(card.id) : '';
      return (
        <article
          class="expanding-cards__card"
          id={card.id}
          data-expanding-card
          data-card-id={card.id}
          data-depth={card.depth !== undefined ? String(card.depth) : undefined}
          data-position={card.position !== undefined ? String(card.position) : undefined}
          style={card.accentToken ? `--accent-fill: ${card.accentToken};` : undefined}
          aria-expanded={card.id === initialActive ? 'true' : 'false'}
          tabindex="0"
          role="button"
          aria-label={`${card.label} â€” click to expand`}
        >
          <div class="expanding-cards__label">{card.label}</div>
          <div class="expanding-cards__content">
            {hasSlot && <Fragment set:html={slotHtml} />}
          </div>
        </article>
      );
    })
  ) : (
    items.map((item) => (
      <article
        class="expanding-cards__card"
        data-expanding-card
        data-card-id={item.id}
        data-accent-token={item.accentToken}
        style={item.accentToken ? `--accent-fill: ${item.accentToken};` : undefined}
        aria-expanded={item.id === initialActive ? 'true' : 'false'}
        tabindex="0"
        role="button"
      >
        <div class="expanding-cards__label">{item.label}</div>
        <div class="expanding-cards__content">
          <h4>{item.title}</h4>
          <p>{item.description}</p>
        </div>
      </article>
    ))
  )}
</div>

<script>
  const BOUND_ATTRIBUTE = 'data-expanding-cards-bound';

  const isMobile = () => window.matchMedia('(max-width: 900px)').matches;

  const syncOrientation = (deck) => {
    const baseOrientation = deck.dataset.orientation === 'horizontal' ? 'horizontal' : 'vertical';
    const activeOrientation = isMobile() ? 'vertical' : baseOrientation;

    deck.classList.remove('expanding-cards--horizontal', 'expanding-cards--vertical');
    deck.classList.add(`expanding-cards--${activeOrientation}`);
    deck.dataset.activeOrientation = activeOrientation;
  };

  const setActiveCard = (deck, cardId) => {
    const cards = deck.querySelectorAll('[data-expanding-card]');

    cards.forEach((card) => {
      const isActive = card.dataset.cardId === cardId;
      card.setAttribute('aria-expanded', isActive ? 'true' : 'false');
      card.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
  };

  const bindDeck = (deck) => {
    if (deck.getAttribute(BOUND_ATTRIBUTE) === 'true') {
      syncOrientation(deck);
      return;
    }

    const cards = deck.querySelectorAll('[data-expanding-card]');
    if (!cards.length) {
      return;
    }

    const defaultActive = deck.dataset.defaultActive || cards[0].dataset.cardId;
    setActiveCard(deck, defaultActive);
    syncOrientation(deck);

    cards.forEach((card) => {
      const activate = () => setActiveCard(deck, card.dataset.cardId);

      card.addEventListener('click', (e) => {
        // If already expanded, ignore clicks inside content (e.g. Tab buttons)
        if (card.getAttribute('aria-expanded') === 'true') {
          const content = card.querySelector('.expanding-cards__content');
          if (content && content.contains(e.target)) return;
        }
        activate();
      });

      card.addEventListener('keydown', (event) => {
        // Only handle keydown on the card element itself, not nested interactives
        if (event.target !== card) return;
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          activate();
        }
      });
    });

    deck.setAttribute(BOUND_ATTRIBUTE, 'true');
  };

  const handleExpandingHash = () => {
    const hash = location.hash.slice(1);
    if (!hash) return;

    document.querySelectorAll('[data-expanding-cards]').forEach((deck) => {
      const card = deck.querySelector(`[data-card-id="${hash}"]`);
      if (card) {
        setActiveCard(deck, hash);
        requestAnimationFrame(() => {
          card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      }
    });
  };

  const initExpandingCards = () => {
    document.querySelectorAll('[data-expanding-cards]').forEach(bindDeck);
    handleExpandingHash();
  };

  document.addEventListener('astro:page-load', initExpandingCards);
  document.addEventListener('astro:after-swap', initExpandingCards);
  window.addEventListener('resize', initExpandingCards);
  window.addEventListener('hashchange', handleExpandingHash);

  initExpandingCards();
</script>
