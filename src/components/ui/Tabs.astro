---
/**
 * Tabs.astro — Mutually exclusive tab panels.
 *
 * Props:
 *   id          – required
 *   accent      – 'teal' | 'amber' | 'blue' | 'gradient' (default: 'teal')
 *   labels      – string[] of tab labels
 *   defaultIndex – 0-based index (default: 0)
 *
 * Slots:
 *   tab-0, tab-1, tab-2, ... tab-7
 *
 * Deep linking:
 *   #id--label (slugified) activates that tab on load.
 *   e.g. #d5-tabs--framework-references
 */
interface Props {
  id: string;
  accent?: 'teal' | 'amber' | 'blue' | 'gradient';
  labels: string[];
  defaultIndex?: number;
}

const {
  id,
  accent = 'teal',
  labels = [],
  defaultIndex = 0,
} = Astro.props;

const maxSupported = 8;
const actualCount = Math.min(labels.length, maxSupported);

function slugify(str: string): string {
  return str.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
}

const visibleLabels = labels.slice(0, actualCount);

const panelEntries = await Promise.all(
  Array.from({ length: actualCount }, async (_, i) => {
    const slotName = `tab-${i}`;
    if (!Astro.slots.has(slotName)) return null;

    const html = await Astro.slots.render(slotName);
    if (!html) return null;

    return {
      i,
      label: visibleLabels[i],
      html,
    };
  }),
);

const panels = panelEntries.filter((panel): panel is NonNullable<typeof panel> => Boolean(panel));
---

<div class={`tabs tabs--${accent}`} id={id} data-tabs>
  <div class="tabs__strip" role="tablist" aria-label={`${id} tabs`}>
    {visibleLabels.map((label, i) => (
      <button
        class="tabs__tab"
        role="tab"
        aria-selected={i === defaultIndex ? 'true' : 'false'}
        aria-controls={`${id}-panel-${i}`}
        id={`${id}-btn-${i}`}
        data-tab-slug={slugify(label)}
        tabindex={i === defaultIndex ? '0' : '-1'}
        type="button"
      >
        {label}
      </button>
    ))}
  </div>

  {panels.map((panel) => (
    <div
      class="tabs__panel"
      role="tabpanel"
      id={`${id}-panel-${panel.i}`}
      aria-labelledby={`${id}-btn-${panel.i}`}
      aria-label={panel.label}
      hidden={defaultIndex !== panel.i}
    >
      <Fragment set:html={panel.html} />
    </div>
  ))}
</div>

<script>
  function initTabs() {
    document.querySelectorAll('[data-tabs]').forEach((tabGroup) => {
      if (tabGroup.hasAttribute('data-tabs-bound')) return;

      const tabs = tabGroup.querySelectorAll('[role="tab"]');
      const panels = tabGroup.querySelectorAll('[role="tabpanel"]');

      function activateTab(tab) {
        tabs.forEach((t) => {
          t.setAttribute('aria-selected', 'false');
          t.setAttribute('tabindex', '-1');
        });
        panels.forEach((p) => { p.hidden = true; });

        tab.setAttribute('aria-selected', 'true');
        tab.removeAttribute('tabindex');

        const controls = tab.getAttribute('aria-controls') || '';
        const panel = document.getElementById(controls);
        if (panel) panel.hidden = false;
      }

      tabs.forEach((tab) => {
        tab.addEventListener('click', () => activateTab(tab));

        tab.addEventListener('keydown', (e) => {
          if (e.key !== 'ArrowRight' && e.key !== 'ArrowLeft') return;
          e.preventDefault();

          const arr = Array.from(tabs);
          const idx = arr.indexOf(tab);
          const delta = e.key === 'ArrowRight' ? 1 : -1;
          const nextIdx = (idx + delta + arr.length) % arr.length;

          activateTab(arr[nextIdx]);
          arr[nextIdx].focus();
        });
      });

      tabGroup.setAttribute('data-tabs-bound', 'true');
    });

    handleTabHash();
  }

  function handleTabHash() {
    const hash = location.hash.slice(1);
    if (!hash || !hash.includes('--')) return;

    const [groupId, tabSlug] = hash.split('--');
    const group = document.getElementById(groupId);
    if (!group) return;

    const target = group.querySelector(`[data-tab-slug="${tabSlug}"]`);
    if (target) {
      target.click();
      requestAnimationFrame(() => {
        group.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    }
  }

  document.addEventListener('astro:page-load', initTabs);
  document.addEventListener('astro:after-swap', initTabs);
  window.addEventListener('hashchange', handleTabHash);

  initTabs();
</script>
