---
/**
 * FlipCard.astro — Two-sided card with click/tap toggle.
 *
 * Props:
 *   id         – Required. Used for deep-linking (#id opens flipped).
 *   accent     – 'teal' | 'amber' | 'blue' | 'gradient' (default: 'teal')
 *   flipDirection – 'horizontal' (rotateY) | 'vertical' (rotateX) (default: 'horizontal')
 *
 * Slots:
 *   front – Content for the front face
 *   back  – Content for the back face
 *
 * Chrome Invariants:
 *   Border: 1px solid var(--border)
 *   Radius: var(--radius-md) = 6px
 *   Background: var(--surface) front, var(--surface-elevated) back
 *   Shadow: var(--shadow-subtle) hover, var(--shadow-card) flipped
 *   Transition: 0.4s ease
 *   Accent: 3px top border stripe only
 */

interface Props {
  id: string;
  accent?: 'teal' | 'amber' | 'blue' | 'gradient';
  flipDirection?: 'horizontal' | 'vertical';
}

const {
  id,
  accent = 'teal',
  flipDirection = 'horizontal',
} = Astro.props;
---

<div
  class={`flip-card flip-card--${accent} flip-card--${flipDirection}`}
  id={id}
  data-flip-card
  data-flip-direction={flipDirection}
  role="button"
  tabindex="0"
  aria-expanded="false"
  aria-label="Flip card — press Enter or Space to flip"
>
  <div class="flip-card__inner">
    <div class="flip-card__face flip-card__front">
      <slot name="front" />
      <span class="flip-card__hint" aria-hidden="true">↻ flip</span>
    </div>
    <div class="flip-card__face flip-card__back">
      <slot name="back" />
      <span class="flip-card__hint" aria-hidden="true">↻ back</span>
    </div>
  </div>
</div>
<script>
  function initFlipCards() {
    document.querySelectorAll('[data-flip-card]').forEach((card) => {
      if (card.hasAttribute('data-flip-bound')) return;

      // Click/tap toggle
      card.addEventListener('click', () => {
        const isFlipped = card.getAttribute('aria-expanded') === 'true';
        card.setAttribute('aria-expanded', isFlipped ? 'false' : 'true');
      });

      // Keyboard: Enter/Space
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          card.click();
        }
      });

      card.setAttribute('data-flip-bound', 'true');
    });

    // Deep linking: if hash matches a flip card ID, open it
    handleFlipCardHash();
  }

  function handleFlipCardHash() {
    const hash = window.location.hash.replace('#', '');
    if (!hash) return;

    const card = document.querySelector(`[data-flip-card]#${CSS.escape(hash)}`);
    if (card) {
      card.setAttribute('aria-expanded', 'true');
      requestAnimationFrame(() => {
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      });
    }
  }

  // Initialize on page load + Astro transitions
  document.addEventListener('astro:page-load', initFlipCards);
  document.addEventListener('astro:after-swap', initFlipCards);
  window.addEventListener('hashchange', handleFlipCardHash);
  initFlipCards();
</script>
