---
/**
 * CoordinatePicker.astro — MVP Coordinate Picker instrument.
 *
 * Two dropdowns: Story Position (clock) + Depth Dimension (D0–D5).
 * Outputs coordinate notation string.
 * "Jump to section" scrolls to matching accordion + opens it.
 * Optional "highlight dimension" toggle.
 */
---

<div class="coord-picker" data-coord-picker>
  <div class="coord-picker__header">
    <span class="coord-picker__icon" aria-hidden="true">⬡</span>
    <span class="coord-picker__title">Coordinate Picker</span>
  </div>

  <div class="coord-picker__controls">
    <div class="coord-picker__field">
      <label class="coord-picker__label" for="coord-position">Position</label>
      <select class="coord-picker__select" id="coord-position" data-coord-position>
        <option value="12:00">12:00 — Origin</option>
        <option value="1:00">1:00 — Catalyst</option>
        <option value="3:00">3:00 — Threshold</option>
        <option value="6:00" selected>6:00 — Midpoint</option>
        <option value="9:00">9:00 — Crisis</option>
        <option value="12:00-R">12:00 — Return</option>
      </select>
    </div>

    <span class="coord-picker__divider" aria-hidden="true">/</span>

    <div class="coord-picker__field">
      <label class="coord-picker__label" for="coord-dimension">Dimension</label>
      <select class="coord-picker__select" id="coord-dimension" data-coord-dimension>
        <option value="d5">D5 — Surface / Expressive</option>
        <option value="d4">D4 — Structural</option>
        <option value="d3">D3 — Cognitive</option>
        <option value="d2" selected>D2 — Psychological</option>
        <option value="d1">D1 — Archetypal</option>
        <option value="d0">D0 — Core</option>
      </select>
    </div>
  </div>

  <div class="coord-picker__output">
    <code class="coord-picker__notation" data-coord-output>[6:00] / [Dimension 2]</code>
    <div class="coord-picker__actions">
      <button class="coord-picker__btn coord-picker__btn--jump" data-coord-jump type="button">
        Jump to section ↓
      </button>
      <button class="coord-picker__btn coord-picker__btn--highlight" data-coord-highlight type="button" aria-pressed="false">
        Highlight dimension
      </button>
    </div>
  </div>
</div>
<script>
  function initCoordPicker() {
    document.querySelectorAll('[data-coord-picker]').forEach((picker) => {
      if (picker.hasAttribute('data-coord-bound')) return;

      const posSelect = picker.querySelector('[data-coord-position]');
      const dimSelect = picker.querySelector('[data-coord-dimension]');
      const output = picker.querySelector('[data-coord-output]');
      const jumpBtn = picker.querySelector('[data-coord-jump]');
      const highlightBtn = picker.querySelector('[data-coord-highlight]');

      if (!posSelect || !dimSelect || !output) return;

      const dimensionNames = {
        d5: 'Surface Dimension 5',
        d4: 'Structural Dimension 4',
        d3: 'Cognitive Dimension 3',
        d2: 'Psychological Dimension 2',
        d1: 'Archetype Dimension 1',
        d0: 'Core Dimension 0',
      };

      const dimensionAnchors = {
        d5: 'd5-expressive',
        d4: 'd4-structural',
        d3: 'd3-cognitive',
        d2: 'd2-psychological',
        d1: 'd1-archetypal',
        d0: 'd0-core',
      };

      function updateOutput() {
        const pos = posSelect.value.replace('-R', '');
        const dim = dimSelect.value;
        const dimName = dimensionNames[dim] || dim;
        output.textContent = `[${pos}] / [${dimName}]`;
      }

      posSelect.addEventListener('change', updateOutput);
      dimSelect.addEventListener('change', updateOutput);

      // Jump to section
      if (jumpBtn) {
        jumpBtn.addEventListener('click', () => {
          const dim = dimSelect.value;
          const anchor = dimensionAnchors[dim];
          if (!anchor) return;

          // Open the accordion/details containing this dimension
          const target = document.getElementById(anchor);
          if (!target) return;

          // Open enclosing <details> if it's inside one
          const details = target.closest('details');
          if (details && !details.open) {
            details.open = true;
          }

          // Scroll into view
          requestAnimationFrame(() => {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          });
        });
      }

      // Highlight dimension toggle
      if (highlightBtn) {
        highlightBtn.addEventListener('click', () => {
          const isActive = highlightBtn.getAttribute('aria-pressed') === 'true';
          highlightBtn.setAttribute('aria-pressed', isActive ? 'false' : 'true');

          const dim = dimSelect.value;
          const anchor = dimensionAnchors[dim];

          // Remove previous highlights
          document.querySelectorAll('.dimension-highlighted').forEach((el) => {
            el.classList.remove('dimension-highlighted');
          });
          document.querySelectorAll('.dimension-dimmed').forEach((el) => {
            el.classList.remove('dimension-dimmed');
          });

          if (!isActive && anchor) {
            // Dim everything, highlight the target
            document.querySelectorAll('[data-accordion-group="dimensions"] .accordion-item').forEach((item) => {
              const details = item.querySelector('details');
              const sectionId = details ? details.querySelector('[id]')?.id : null;
              if (sectionId === anchor) {
                item.classList.add('dimension-highlighted');
              } else {
                item.classList.add('dimension-dimmed');
              }
            });
          }
        });
      }

      picker.setAttribute('data-coord-bound', 'true');
    });
  }

  document.addEventListener('astro:page-load', initCoordPicker);
  document.addEventListener('astro:after-swap', initCoordPicker);
  initCoordPicker();
</script>
